# è¯·æ±‚å¤´æ¡ä»¶è¦†ç›–åŠŸèƒ½æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸º new-api é¡¹ç›®æ–°å¢äº†**è¯·æ±‚å¤´æ¡ä»¶è¦†ç›–**åŠŸèƒ½ï¼Œå…è®¸æ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚å¤´çš„ç‰¹å¾åŠ¨æ€å†³å®šæ˜¯å¦è¦†ç›–è½¬å‘ç»™ä¸Šæ¸¸æœåŠ¡çš„è¯·æ±‚å¤´ã€‚

### æ”¹åŠ¨ç»Ÿè®¡

```
relay/channel/api_request.go         |  28 +++-
relay/common/header_override.go      | 181 ++++++++++++++++++
relay/common/header_override_test.go | 464 ++++++++++++++++++++++++++++++++++++
3 files changed, 668 insertions(+), 5 deletions(-)
```

### æ ¸å¿ƒç›®æ ‡

1. **å‘åå…¼å®¹**ï¼šä¿æŒå¯¹ç°æœ‰ç®€å•æ¨¡å¼é…ç½®çš„å®Œå…¨å…¼å®¹
2. **æ¡ä»¶åˆ¤æ–­**ï¼šæ”¯æŒæ ¹æ®è¯·æ±‚å¤´ç‰¹å¾åŠ¨æ€å†³å®šæ˜¯å¦è¦†ç›–
3. **çµæ´»é…ç½®**ï¼šæ”¯æŒå¤šç§åŒ¹é…æ¨¡å¼å’Œé€»è¾‘ç»„åˆ
4. **å®‰å…¨å›é€€**ï¼šé…ç½®é”™è¯¯æ—¶ä¸åšä»»ä½•è¦†ç›–ï¼Œé¿å…æ„å¤–è¡Œä¸º

### å…¸å‹ä½¿ç”¨åœºæ™¯

1. **åŒºåˆ†å®¢æˆ·ç«¯ç±»å‹**ï¼šä¸ºä¸åŒçš„å®¢æˆ·ç«¯ï¼ˆå¦‚æµè§ˆå™¨ã€CLI å·¥å…·ï¼‰è®¾ç½®ä¸åŒçš„ User-Agent
2. **API Key åŠ¨æ€æ›¿æ¢**ï¼šåœ¨è¯·æ±‚å¤´ä¸­åŠ¨æ€æ’å…¥ API Key
3. **æ¡ä»¶æ€§è¦†ç›–**ï¼šåªå¯¹ç‰¹å®šæ¥æºçš„è¯·æ±‚è¦†ç›–è¯·æ±‚å¤´
4. **å¤šæ¡ä»¶åˆ¤æ–­**ï¼šç»„åˆå¤šä¸ªæ¡ä»¶å®ç°å¤æ‚çš„è¦†ç›–é€»è¾‘

---

## é…ç½®æ¨¡å¼

ç³»ç»Ÿæ”¯æŒä¸¤ç§é…ç½®æ¨¡å¼ï¼š

### 1. ç®€å•æ¨¡å¼ï¼ˆå‘åå…¼å®¹ï¼‰

ç›´æ¥ä½¿ç”¨ key-value å¯¹é…ç½®è¯·æ±‚å¤´è¦†ç›–ã€‚

**é€‚ç”¨åœºæ™¯**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä½¿ç”¨ç›¸åŒçš„è¦†ç›–è§„åˆ™ï¼Œæ— éœ€æ¡ä»¶åˆ¤æ–­ã€‚

**ç¤ºä¾‹**ï¼š
```json
{
  "User-Agent": "custom-agent/1.0",
  "X-Custom-Header": "Bearer {api_key}"
}
```

### 2. é«˜çº§æ¨¡å¼ï¼ˆæ¡ä»¶åˆ¤æ–­ï¼‰

ä½¿ç”¨ `operations` å­—æ®µå®šä¹‰æ¡ä»¶å’Œè¦†ç›–è§„åˆ™ã€‚

**é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦æ ¹æ®è¯·æ±‚å¤´ç‰¹å¾åŠ¨æ€å†³å®šæ˜¯å¦è¦†ç›–ã€‚

**ç¤ºä¾‹**ï¼š
```json
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "claude-cli/2.0.50 (external, cli)",
      "conditions": [
        {
          "header": "User-Agent",
          "mode": "contains",
          "value": "claude-cli",
          "invert": true
        }
      ]
    }
  ]
}
```

---

## é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç®€å•æ¨¡å¼ - å›ºå®šè¦†ç›–

**åœºæ™¯**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä½¿ç”¨å›ºå®šçš„ User-Agentã€‚

```json
{
  "User-Agent": "my-custom-agent/1.0.0",
  "X-API-Key": "{api_key}"
}
```

**è¯´æ˜**ï¼š
- æ‰€æœ‰è¯·æ±‚çš„ `User-Agent` éƒ½ä¼šè¢«è¦†ç›–ä¸º `my-custom-agent/1.0.0`
- `{api_key}` ä¼šè¢«æ›¿æ¢ä¸ºå®é™…çš„ API Key

---

### ç¤ºä¾‹ 2ï¼šåŸºç¡€é«˜çº§æ¨¡å¼ - æ— æ¡ä»¶è¦†ç›–

**åœºæ™¯**ï¼šä½¿ç”¨é«˜çº§æ¨¡å¼ä½†ä¸è®¾ç½®æ¡ä»¶ï¼Œæ•ˆæœç±»ä¼¼ç®€å•æ¨¡å¼ã€‚

```json
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "custom-agent/2.0"
    },
    {
      "header": "X-Custom-Header",
      "value": "custom-value"
    }
  ]
}
```

**è¯´æ˜**ï¼š
- æ²¡æœ‰ `conditions` å­—æ®µï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šåº”ç”¨è¦†ç›–
- å¯ä»¥å®šä¹‰å¤šä¸ª operation

---

### ç¤ºä¾‹ 3ï¼šæ¡ä»¶åˆ¤æ–­ - ä»…å¯¹é claude-cli è¯·æ±‚è¦†ç›–

**åœºæ™¯**ï¼šåªæœ‰å½“ User-Agent ä¸åŒ…å« "claude-cli" æ—¶æ‰è¦†ç›–ä¸º claude-cliã€‚

```json
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "claude-cli/2.0.37",
      "conditions": [
        {
          "header": "User-Agent",
          "mode": "contains",
          "value": "claude-cli",
          "invert": true
        }
      ]
    }
  ]
}
```

**è¯´æ˜**ï¼š
- `mode: "contains"` è¡¨ç¤ºæ£€æŸ¥ User-Agent æ˜¯å¦åŒ…å« "claude-cli"
- `invert: true` è¡¨ç¤ºæ¡ä»¶å–åï¼Œå³"ä¸åŒ…å«"æ—¶æ¡ä»¶æ»¡è¶³
- æ¡ä»¶æ»¡è¶³æ—¶ï¼ŒUser-Agent ä¼šè¢«è¦†ç›–ä¸º "claude-cli/2.0.37"

**è¡Œä¸º**ï¼š
- è¯·æ±‚ User-Agent ä¸º `Mozilla/5.0` â†’ è¦†ç›–ä¸º `claude-cli/2.0.37`
- è¯·æ±‚ User-Agent ä¸º `claude-cli/2.0.30` â†’ ä¸è¦†ç›–ï¼Œä¿æŒåŸå€¼

---

### ç¤ºä¾‹ 4ï¼šå¤šæ¡ä»¶ AND ç»„åˆ

**åœºæ™¯**ï¼šåŒæ—¶æ»¡è¶³å¤šä¸ªæ¡ä»¶æ—¶æ‰è¦†ç›–ã€‚

```json
{
  "operations": [
    {
      "header": "Authorization",
      "value": "Bearer {api_key}",
      "conditions": [
        {
          "header": "User-Agent",
          "mode": "contains",
          "value": "Mozilla"
        },
        {
          "header": "X-Client-Type",
          "mode": "full",
          "value": "browser"
        }
      ],
      "logic": "AND"
    }
  ]
}
```

**è¯´æ˜**ï¼š
- `logic: "AND"` è¡¨ç¤ºæ‰€æœ‰æ¡ä»¶éƒ½å¿…é¡»æ»¡è¶³
- æ¡ä»¶ 1ï¼šUser-Agent åŒ…å« "Mozilla"
- æ¡ä»¶ 2ï¼šX-Client-Type å®Œå…¨ç­‰äº "browser"
- åªæœ‰ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ—¶æ‰è¦†ç›– Authorization å¤´

**è¡Œä¸º**ï¼š
- UA åŒ…å« Mozilla ä¸” X-Client-Type ä¸º browser â†’ è¦†ç›–
- UA åŒ…å« Mozilla ä½† X-Client-Type ä¸º cli â†’ ä¸è¦†ç›–
- UA ä¸º curl ä¸” X-Client-Type ä¸º browser â†’ ä¸è¦†ç›–

---

### ç¤ºä¾‹ 5ï¼šå¤šæ¡ä»¶ OR ç»„åˆ

**åœºæ™¯**ï¼šæ»¡è¶³ä»»ä¸€æ¡ä»¶å³è¦†ç›–ã€‚

```json
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "standardized-client/1.0",
      "conditions": [
        {
          "header": "User-Agent",
          "mode": "contains",
          "value": "curl"
        },
        {
          "header": "User-Agent",
          "mode": "contains",
          "value": "wget"
        },
        {
          "header": "User-Agent",
          "mode": "prefix",
          "value": "python-requests"
        }
      ],
      "logic": "OR"
    }
  ]
}
```

**è¯´æ˜**ï¼š
- `logic: "OR"` è¡¨ç¤ºä»»ä¸€æ¡ä»¶æ»¡è¶³å³å¯ï¼ˆé»˜è®¤å€¼ï¼‰
- æ£€æµ‹å¸¸è§çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆcurlã€wgetã€python-requestsï¼‰
- ä»»ä¸€æ¡ä»¶æ»¡è¶³æ—¶ï¼Œç»Ÿä¸€è¦†ç›–ä¸ºæ ‡å‡† User-Agent

---

### ç¤ºä¾‹ 6ï¼šå¤šä¸ª operation ç»„åˆ

**åœºæ™¯**ï¼šä¸ºä¸åŒå®¢æˆ·ç«¯è®¾ç½®ä¸åŒçš„è¯·æ±‚å¤´ã€‚

```json
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "claude-cli/2.0.37",
      "conditions": [
        {
          "header": "User-Agent",
          "mode": "contains",
          "value": "claude-cli",
          "invert": true
        }
      ]
    },
    {
      "header": "X-Custom-Header",
      "value": "api-value",
      "conditions": [
        {
          "header": "X-Client-Type",
          "mode": "full",
          "value": "api"
        }
      ]
    }
  ]
}
```

**è¯´æ˜**ï¼š
- ç¬¬ä¸€ä¸ª operationï¼šå¯¹é claude-cli å®¢æˆ·ç«¯è¦†ç›– User-Agent
- ç¬¬äºŒä¸ª operationï¼šå¯¹ api ç±»å‹å®¢æˆ·ç«¯æ·»åŠ è‡ªå®šä¹‰å¤´
- ä¸¤ä¸ª operation ç‹¬ç«‹åˆ¤æ–­ï¼Œå¯ä»¥åŒæ—¶ç”Ÿæ•ˆ

---

## å­—æ®µè¯¦ç»†è¯´æ˜

### operations æ•°ç»„

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `header` | string | âœ… æ˜¯ | è¦è¦†ç›–çš„è¯·æ±‚å¤´åç§° | `"User-Agent"` |
| `value` | string | âœ… æ˜¯ | è¦†ç›–åçš„å€¼ï¼Œæ”¯æŒå˜é‡æ›¿æ¢ | `"Bearer {api_key}"` |
| `conditions` | array | âŒ å¦ | æ¡ä»¶åˆ—è¡¨ï¼›ä¸å¡«è¡¨ç¤ºæ— æ¡ä»¶ï¼Œ**å¦‚æœæä¾›åˆ™å¿…é¡»è‡³å°‘æœ‰ 1 ä¸ªæœ‰æ•ˆæ¡ä»¶** | è§ä¸‹æ–¹ |
| `logic` | string | âŒ å¦ | æ¡ä»¶é€»è¾‘ï¼š`"AND"` æˆ– `"OR"`ï¼Œé»˜è®¤ `"OR"` | `"AND"` |

### conditions æ•°ç»„

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `header` | string | âœ… æ˜¯ | è¦æ£€æŸ¥çš„è¯·æ±‚å¤´åç§° | `"User-Agent"` |
| `mode` | string | âŒ å¦ | åŒ¹é…æ¨¡å¼ï¼Œé»˜è®¤ `"contains"` | `"prefix"` |
| `value` | string | âœ… æ˜¯ | åŒ¹é…çš„å€¼ | `"Mozilla"` |
| `invert` | boolean | âŒ å¦ | æ˜¯å¦å–åï¼Œé»˜è®¤ `false` | `true` |

### mode åŒ¹é…æ¨¡å¼è¯¦è§£

| æ¨¡å¼ | è¯´æ˜ | ç¤ºä¾‹ | åŒ¹é…ç»“æœ |
|------|------|------|----------|
| `full` | å®Œå…¨åŒ¹é… | `value: "Mozilla/5.0"` | `"Mozilla/5.0"` âœ…<br>`"Mozilla/5.0.1"` âŒ |
| `prefix` | å‰ç¼€åŒ¹é… | `value: "Mozilla"` | `"Mozilla/5.0"` âœ…<br>`"Chrome"` âŒ |
| `suffix` | åç¼€åŒ¹é… | `value: "5.0"` | `"Mozilla/5.0"` âœ…<br>`"Mozilla/6.0"` âŒ |
| `contains` | åŒ…å«åŒ¹é…ï¼ˆé»˜è®¤ï¼‰ | `value: "Mozilla"` | `"Mozilla/5.0"` âœ…<br>`"Chrome/Mozilla"` âœ…<br>`"Chrome"` âŒ |

### invert å–åé€»è¾‘

| invert | æ¡ä»¶ | ç»“æœ |
|--------|------|------|
| `false` | åŒ¹é…æˆåŠŸ | æ¡ä»¶æ»¡è¶³ âœ… |
| `false` | åŒ¹é…å¤±è´¥ | æ¡ä»¶ä¸æ»¡è¶³ âŒ |
| `true` | åŒ¹é…æˆåŠŸ | æ¡ä»¶ä¸æ»¡è¶³ âŒ |
| `true` | åŒ¹é…å¤±è´¥ | æ¡ä»¶æ»¡è¶³ âœ… |

**ä½¿ç”¨åœºæ™¯**ï¼š
- `invert: false`ï¼ˆé»˜è®¤ï¼‰ï¼šæ­£å‘åŒ¹é…ï¼Œå¦‚"åŒ…å« Mozilla"
- `invert: true`ï¼šåå‘åŒ¹é…ï¼Œå¦‚"ä¸åŒ…å« curl"

### logic é€»è¾‘ç»„åˆ

| logic | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|
| `OR`ï¼ˆé»˜è®¤ï¼‰ | ä»»ä¸€æ¡ä»¶æ»¡è¶³å³å¯ | æ¡ä»¶1 âœ… æˆ– æ¡ä»¶2 âœ… â†’ è¦†ç›– |
| `AND` | æ‰€æœ‰æ¡ä»¶éƒ½å¿…é¡»æ»¡è¶³ | æ¡ä»¶1 âœ… ä¸” æ¡ä»¶2 âœ… â†’ è¦†ç›– |

---

## å˜é‡æ›¿æ¢

### å½“å‰æ”¯æŒçš„å˜é‡

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `{api_key}` | å½“å‰ channel çš„ API Key | `"Bearer {api_key}"` â†’ `"Bearer sk-xxx"` |

### ä½¿ç”¨æ–¹å¼

åœ¨ `value` å­—æ®µä¸­ä½¿ç”¨ `{å˜é‡å}` æ ¼å¼ï¼š

```json
{
  "header": "Authorization",
  "value": "Bearer {api_key}"
}
```

> æ³¨æ„ï¼šä»…å½“ `RelayInfo` ä¸ `ChannelMeta` éç©ºæ—¶æ‰ä¼šæ‰§è¡Œ `{api_key}` æ›¿æ¢ï¼›å¦åˆ™ä¼šåŸæ ·è¿”å›ï¼Œä¾¿äºåœ¨ç¼ºå°‘ä¸Šä¸‹æ–‡æ—¶ä¿æŒå®‰å…¨ã€‚

### æœªæ¥å¯æ‰©å±•çš„å˜é‡

- `{model}`: å½“å‰è¯·æ±‚çš„æ¨¡å‹åç§°
- `{user_id}`: å½“å‰ç”¨æˆ· ID
- `{channel_id}`: å½“å‰ channel ID

---

## æ¨¡å¼åˆ¤æ–­é€»è¾‘

### åˆ¤æ–­æµç¨‹

```
é…ç½®ä¸­æ˜¯å¦å­˜åœ¨ "operations" å­—æ®µï¼Ÿ
â”‚
â”œâ”€ æ˜¯ â†’ å°è¯•è§£æ operations
â”‚   â”‚
â”‚   â”œâ”€ è§£ææˆåŠŸ â†’ ä½¿ç”¨é«˜çº§æ¨¡å¼
â”‚   â”‚              åº”ç”¨æ¡ä»¶åˆ¤æ–­å’Œè¦†ç›–
â”‚   â”‚
â”‚   â””â”€ è§£æå¤±è´¥ â†’ å®‰å…¨å›é€€
â”‚                  ä¸åšä»»ä½•è¦†ç›–
â”‚
â””â”€ å¦ â†’ ä½¿ç”¨ç®€å•æ¨¡å¼
        ç›´æ¥åº”ç”¨ key-value è¦†ç›–
```

### è§£æå¤±è´¥çš„æƒ…å†µ

ä»¥ä¸‹æƒ…å†µä¼šå¯¼è‡´è§£æå¤±è´¥ï¼Œè§¦å‘å®‰å…¨å›é€€ï¼ˆä¸åšä»»ä½•è¦†ç›–ï¼‰ï¼š

1. **å¿…éœ€å­—æ®µç¼ºå¤±/éæ³•**
   - operation çš„ `header` æˆ– `value` ä¸ºç©º/ç¼ºå¤±
   - `logic` å­˜åœ¨ä½†ç±»å‹ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œæˆ–å€¼ä¸åœ¨ `AND` / `OR`

2. **operations ç»“æ„é”™è¯¯**
   - `operations` ä¸æ˜¯æ•°ç»„ï¼Œæˆ–æ•°ç»„ä¸ºç©º
   - æ•°ç»„é‡Œæ²¡æœ‰ä»»ä½•å¯ç”¨çš„ operationï¼ˆä¾‹å¦‚å…¨æ˜¯éå¯¹è±¡é¡¹ï¼‰

3. **conditions ç›¸å…³é”™è¯¯**
   - `conditions` å­—æ®µå­˜åœ¨ä½†ä¸æ˜¯æ•°ç»„
   - `conditions` æ•°ç»„ä¸ºç©º
   - `conditions` å…¨éƒ¨æ— æ•ˆï¼ˆå¦‚ `header`/`value` ä¸ºç©ºï¼Œ`mode` ç±»å‹/å€¼éæ³•ï¼Œ`invert` ç±»å‹éæ³•ï¼‰ï¼Œå¯¼è‡´è¯¥ operation æ— æœ‰æ•ˆæ¡ä»¶

æ»¡è¶³ä»¥ä¸Šä»»ä¸€æ¡æ—¶ï¼Œé«˜çº§æ¨¡å¼æ•´ä½“å›é€€ä¸ºâ€œä¸åšè¦†ç›–â€ï¼Œä¸ä¼šé™çº§åˆ°ç®€å•æ¨¡å¼ã€‚

### å®‰å…¨å›é€€è®¾è®¡æ€è·¯

**ä¸ºä»€ä¹ˆé‡‡ç”¨å®‰å…¨å›é€€ï¼Ÿ**

å½“é…ç½®åŒ…å« `operations` å­—æ®µä½†è§£æå¤±è´¥æ—¶ï¼Œç³»ç»Ÿé€‰æ‹©"ä¸åšä»»ä½•è¦†ç›–"è€Œé"å›é€€åˆ°ç®€å•æ¨¡å¼"ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. **é…ç½®æ„å›¾æ˜ç¡®**ï¼šå­˜åœ¨ `operations` è¡¨æ˜ç”¨æˆ·æƒ³ä½¿ç”¨é«˜çº§æ¨¡å¼
2. **é¿å…è¯¯æ“ä½œ**ï¼šè§£æå¤±è´¥å¯èƒ½å¯¼è‡´ä¸ç¬¦åˆé¢„æœŸçš„è¡Œä¸º
3. **æ˜“äºæ’æŸ¥**ï¼šå®Œå…¨ä¸è¦†ç›–æ¯”éƒ¨åˆ†è¦†ç›–æ›´å®¹æ˜“å‘ç°é—®é¢˜
4. **Fail-safe åŸåˆ™**ï¼šå‡ºé”™æ—¶ä¿æŒåŸå§‹è¯·æ±‚å¤´æ›´å®‰å…¨

**è§£æå¤±è´¥çš„æ—¥å¿—è®°å½•**

å½“ operations è§£æå¤±è´¥è§¦å‘å®‰å…¨å›é€€æ—¶ï¼Œç³»ç»Ÿä¼šè®°å½• **warning çº§åˆ«**çš„æ—¥å¿—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```
header override operations parse failed for channel_id=123, falling back to no override
```

æ—¥å¿—ä¸­åŒ…å«çš„ä¿¡æ¯ï¼š
- **channel_id**: å‘ç”Ÿé…ç½®é”™è¯¯çš„æ¸ é“ IDï¼Œæ–¹ä¾¿å®šä½é—®é¢˜
- **çº§åˆ«**: warningï¼ˆè¡¨ç¤ºåŠŸèƒ½é™çº§ï¼Œä¸æ˜¯ç³»ç»Ÿé”™è¯¯ï¼‰
- **è¯´æ˜**: é…ç½®è§£æå¤±è´¥ï¼Œè‡ªåŠ¨å›é€€åˆ°ä¸åšä»»ä½•è¦†ç›–

**å¦‚ä½•æ’æŸ¥é…ç½®é”™è¯¯**

å¦‚æœåœ¨æ—¥å¿—ä¸­çœ‹åˆ°æ­¤è­¦å‘Šï¼š
1. æ£€æŸ¥å¯¹åº” channel çš„ headers_override é…ç½®
2. éªŒè¯ operations æ•°ç»„æ˜¯å¦ä¸ºç©º
3. ç¡®è®¤æ¯ä¸ª operation æ˜¯å¦åŒ…å«å¿…éœ€çš„ `header` å’Œ `value` å­—æ®µ
4. æ£€æŸ¥ conditionsã€logicã€mode ç­‰å­—æ®µçš„ç±»å‹å’Œå€¼æ˜¯å¦åˆæ³•
5. å‚è€ƒæœ¬æ–‡æ¡£çš„é…ç½®ç¤ºä¾‹è¿›è¡Œä¿®æ­£

---

## æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ

### âš ï¸ é…ç½®é”™è¯¯çš„å¸¸è§æƒ…å†µ

#### 1. ç¼ºå°‘å¿…éœ€å­—æ®µ

âŒ **é”™è¯¯**ï¼š
```json
{
  "operations": [
    {
      "value": "custom-agent"
      // ç¼ºå°‘ header å­—æ®µ
    }
  ]
}
```

âœ… **æ­£ç¡®**ï¼š
```json
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "custom-agent"
    }
  ]
}
```

#### 2. header å­—æ®µä¸ºç©º

âŒ **é”™è¯¯**ï¼š
```json
{
  "operations": [
    {
      "header": "",
      "value": "custom-agent"
    }
  ]
}
```

#### 3. operations æ•°ç»„ä¸ºç©º

âŒ **é”™è¯¯**ï¼š
```json
{
  "operations": []
}
```

**ç»“æœ**ï¼šè§£æå¤±è´¥ï¼Œä¸åšä»»ä½•è¦†ç›–

#### 4. æ··ç”¨ç®€å•æ¨¡å¼å’Œé«˜çº§æ¨¡å¼

âš ï¸ **ä¸æ¨è**ï¼š
```json
{
  "User-Agent": "simple-mode",
  "operations": [...]
}
```

**è¯´æ˜**ï¼šä¸€æ—¦å­˜åœ¨ `operations` å­—æ®µï¼Œç®€å•æ¨¡å¼çš„é…ç½®ä¼šè¢«å¿½ç•¥ã€‚

#### 5. conditions é…ç½®é”™è¯¯

âŒ **é”™è¯¯**ï¼š
```json
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "custom-agent",
      "conditions": []
    }
  ]
}
```

**ç»“æœ**ï¼šconditions ä¸ºç©ºæ•°ç»„æˆ–å…¨éƒ¨æ— æ•ˆï¼ˆheader/value ä¸ºç©ºï¼Œmode å€¼/ç±»å‹éæ³•ï¼Œinvert ç±»å‹éæ³•ï¼‰æ—¶ï¼Œä¼šå¯¼è‡´é«˜çº§æ¨¡å¼è§£æå¤±è´¥å¹¶å›é€€ä¸ºâ€œä¸è¦†ç›–â€ã€‚

#### 6. logic é…ç½®é”™è¯¯

âŒ **é”™è¯¯**ï¼š
```json
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "custom-agent",
      "logic": "XOR"
    }
  ]
}
```

**ç»“æœ**ï¼šlogic ä»…æ¥å—å­—ç¬¦ä¸² `AND` / `OR`ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰ã€‚ç±»å‹é”™è¯¯æˆ–éæ³•å–å€¼ä¼šè§¦å‘å®‰å…¨å›é€€ã€‚

### âœ… æœ€ä½³å®è·µ

#### 1. é…ç½®éªŒè¯

åœ¨éƒ¨ç½²å‰éªŒè¯é…ç½®ï¼š
- ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨
- æ£€æŸ¥ `mode` å€¼æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…ï¼ˆfull/prefix/suffix/containsï¼‰
- æ£€æŸ¥ `logic` å€¼æ˜¯å¦ä¸º AND æˆ– OR

#### 2. æ¸è¿›å¼è¿ç§»

å¦‚æœä»ç®€å•æ¨¡å¼è¿ç§»åˆ°é«˜çº§æ¨¡å¼ï¼š
```json
// ç¬¬ä¸€æ­¥ï¼šä¿æŒç®€å•æ¨¡å¼
{
  "User-Agent": "custom-agent"
}

// ç¬¬äºŒæ­¥ï¼šè½¬æ¢ä¸ºæ— æ¡ä»¶çš„é«˜çº§æ¨¡å¼
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "custom-agent"
    }
  ]
}

// ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ æ¡ä»¶
{
  "operations": [
    {
      "header": "User-Agent",
      "value": "custom-agent",
      "conditions": [...]
    }
  ]
}
```

#### 3. æ¡ä»¶è®¾è®¡åŸåˆ™

- **æ˜ç¡®æ€§**ï¼šæ¡ä»¶åº”è¯¥æ˜ç¡®ä¸”å¯é¢„æµ‹
- **ç‹¬ç«‹æ€§**ï¼šé¿å…æ¡ä»¶ä¹‹é—´ç›¸äº’çŸ›ç›¾
- **å¯æµ‹è¯•æ€§**ï¼šä¾¿äºéªŒè¯é…ç½®æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ

#### 4. è°ƒè¯•æŠ€å·§

å¦‚æœè¦†ç›–æ²¡æœ‰ç”Ÿæ•ˆï¼š
1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ `operations` å­—æ®µä½†é…ç½®é”™è¯¯
2. éªŒè¯æ¡ä»¶æ˜¯å¦æ­£ç¡®åŒ¹é…
3. æ£€æŸ¥ `logic` æ˜¯å¦è®¾ç½®æ­£ç¡®ï¼ˆAND/ORï¼‰
4. ç¡®è®¤ `invert` çš„ä½¿ç”¨æ˜¯å¦ç¬¦åˆé¢„æœŸ

### ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **API Key ä¿æŠ¤**
   - ä½¿ç”¨ `{api_key}` å˜é‡è€Œéç¡¬ç¼–ç 
   - é¿å…åœ¨æ—¥å¿—ä¸­è¾“å‡ºåŒ…å« API Key çš„è¯·æ±‚å¤´

2. **å®¢æˆ·ç«¯ä¼ªé€ **
   - æ¶æ„å®¢æˆ·ç«¯å¯ä»¥ä¼ªé€ è¯·æ±‚å¤´æ¥è§¦å‘æˆ–ç»•è¿‡æ¡ä»¶
   - æ¡ä»¶åˆ¤æ–­é€‚ç”¨äºåŒºåˆ†æ­£å¸¸å®¢æˆ·ç«¯ï¼Œä¸é€‚åˆä½œä¸ºå®‰å…¨è¾¹ç•Œ

3. **æ•æ„Ÿä¿¡æ¯æ³„éœ²**
   - è°¨æ…ä½¿ç”¨å˜é‡æ›¿æ¢ï¼Œé¿å…å°†æ•æ„Ÿä¿¡æ¯æš´éœ²ç»™ä¸å¯ä¿¡çš„ä¸Šæ¸¸

### âš¡ æ€§èƒ½è€ƒè™‘

1. **æ¡ä»¶æ•°é‡**
   - æ¯ä¸ªè¯·æ±‚éƒ½ä¼šæ‰§è¡Œæ¡ä»¶åˆ¤æ–­
   - å»ºè®®å•ä¸ª operation çš„ conditions ä¸è¶…è¿‡ 5 ä¸ª

2. **operations æ•°é‡**
   - operations æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„éƒ½ä¼šç”Ÿæ•ˆ
   - å»ºè®® operations æ•°é‡ä¸è¶…è¿‡ 10 ä¸ª

3. **å­—ç¬¦ä¸²åŒ¹é…**
   - `contains` æ¨¡å¼æ¯” `full` æ¨¡å¼ç¨æ…¢
   - å¯¹äºé«˜æµé‡åœºæ™¯ï¼Œä¼˜å…ˆä½¿ç”¨ `full` æˆ– `prefix`

---

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•è¦†ç›–åœºæ™¯

é¡¹ç›®æ–°å¢äº† 464 è¡Œå•å…ƒæµ‹è¯•ï¼ˆ`relay/common/header_override_test.go`ï¼‰ï¼Œè¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š

#### 1. é…ç½®è§£ææµ‹è¯•
- âœ… æœ‰æ•ˆé…ç½®çš„è§£æ
- âœ… ç¼ºå°‘å¿…éœ€å­—æ®µæ—¶çš„é”™è¯¯å¤„ç†
- âœ… ç©ºå­—æ®µçš„å¤„ç†ï¼ˆoperation header/value ä¸ºç©ºè§¦å‘å¤±è´¥ï¼‰
- âœ… ç©º operations æ•°ç»„çš„å¤„ç†
- âœ… å¸¦æ¡ä»¶çš„é…ç½®è§£æ
- âœ… æ¡ä»¶æ— æ•ˆ/æ¡ä»¶ç±»å‹é”™è¯¯/æ¡ä»¶ä¸ºç©ºæ•°ç»„æ—¶çš„å›é€€
- âœ… logic ç±»å‹é”™è¯¯æˆ–éæ³•å€¼æ—¶çš„å›é€€ï¼Œåˆæ³•å€¼å¤§å°å†™ä¸æ•æ„Ÿ
- âœ… mode/invert ç±»å‹æˆ–å–å€¼éæ³•çš„å¤„ç†

#### 2. æ¡ä»¶åˆ¤æ–­æµ‹è¯•
- âœ… contains æ¨¡å¼ï¼ˆåŒ…å«ã€ä¸åŒ…å«ã€å–åï¼‰
- âœ… full æ¨¡å¼ï¼ˆå®Œå…¨åŒ¹é…ï¼‰
- âœ… prefix æ¨¡å¼ï¼ˆå‰ç¼€åŒ¹é…ï¼‰
- âœ… suffix æ¨¡å¼ï¼ˆåç¼€åŒ¹é…ï¼‰
- âœ… AND é€»è¾‘ç»„åˆ
- âœ… OR é€»è¾‘ç»„åˆ

#### 3. è¦†ç›–åº”ç”¨æµ‹è¯•
- âœ… åŸºç¡€è¦†ç›–ï¼ˆæ— æ¡ä»¶ï¼‰
- âœ… æ¡ä»¶è¦†ç›–ï¼ˆæ»¡è¶³æ¡ä»¶æ—¶è¦†ç›–ï¼‰
- âœ… æ¡ä»¶ä¸æ»¡è¶³æ—¶ä¸è¦†ç›–

#### 4. å˜é‡æ›¿æ¢æµ‹è¯•
- âœ… {api_key} å˜é‡æ›¿æ¢
- âœ… æ— å˜é‡çš„æƒ…å†µ
- âœ… å¤šæ¬¡å˜é‡æ›¿æ¢

### å¦‚ä½•éªŒè¯é…ç½®

#### æ–¹æ³• 1ï¼šå•å…ƒæµ‹è¯•

åˆ›å»ºæµ‹è¯•ç”¨ä¾‹éªŒè¯é…ç½®ï¼š

```go
func TestMyHeaderConfig(t *testing.T) {
    config := map[string]interface{}{
        "operations": []interface{}{
            map[string]interface{}{
                "header": "User-Agent",
                "value":  "custom-agent",
                "conditions": []interface{}{
                    map[string]interface{}{
                        "header": "User-Agent",
                        "mode":   "contains",
                        "value":  "Mozilla",
                    },
                },
            },
        },
    }

    operations, ok := common.TryParseHeaderOperations(config)
    if !ok {
        t.Fatal("Config parsing failed")
    }

    // éªŒè¯è§£æç»“æœ
    assert.Equal(t, 1, len(operations))
    assert.Equal(t, "User-Agent", operations[0].Header)
}
```

#### æ–¹æ³• 2ï¼šæ—¥å¿—è§‚å¯Ÿ

éƒ¨ç½²åè§‚å¯Ÿå®é™…è¯·æ±‚å¤´æ˜¯å¦æŒ‰é¢„æœŸè¦†ç›–ã€‚

#### æ–¹æ³• 3ï¼šæ‰‹åŠ¨æµ‹è¯•

ä½¿ç”¨ä¸åŒçš„å®¢æˆ·ç«¯ï¼ˆcurlã€æµè§ˆå™¨ã€claude-cliï¼‰æµ‹è¯•é…ç½®æ•ˆæœã€‚

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### æ ¸å¿ƒæ•°æ®ç»“æ„

```go
// HeaderCondition è¯·æ±‚å¤´æ¡ä»¶åˆ¤æ–­
type HeaderCondition struct {
    Header string `json:"header"` // è¦æ£€æŸ¥çš„è¯·æ±‚å¤´åç§°
    Mode   string `json:"mode"`   // full, prefix, suffix, contains
    Value  string `json:"value"`  // åŒ¹é…çš„å€¼
    Invert bool   `json:"invert"` // æ˜¯å¦å–å
}

// HeaderOperation è¯·æ±‚å¤´è¦†ç›–æ“ä½œ
type HeaderOperation struct {
    Header     string            `json:"header"`     // è¦è¦†ç›–çš„è¯·æ±‚å¤´åç§°
    Value      string            `json:"value"`      // è¦†ç›–åçš„å€¼
    Conditions []HeaderCondition `json:"conditions"` // æ¡ä»¶åˆ—è¡¨
    Logic      string            `json:"logic"`      // AND, OR (é»˜è®¤OR)
}
```

### æ ¸å¿ƒå‡½æ•°

1. **TryParseHeaderOperations**: è§£æé…ç½®
2. **checkHeaderConditions**: æ£€æŸ¥æ¡ä»¶åˆ—è¡¨
3. **checkSingleHeaderCondition**: æ£€æŸ¥å•ä¸ªæ¡ä»¶
4. **ApplyHeaderOperations**: åº”ç”¨è¦†ç›–è§„åˆ™
5. **replaceHeaderVariables**: å˜é‡æ›¿æ¢

### é›†æˆç‚¹

ä¿®æ”¹äº†ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°çš„è°ƒç”¨æ–¹å¼ï¼š
- `DoApiRequest`
- `DoFormRequest`
- `DoWssRequest`

æ‰€æœ‰å‡½æ•°éƒ½è°ƒç”¨ `processHeaderOverride(c, info)` æ¥è·å–è¦†ç›–çš„è¯·æ±‚å¤´ã€‚

### æ‰§è¡Œé¡ºåº

ä¸ºäº†ç¡®ä¿ `headerOverride` çš„ä¼˜å…ˆçº§æœ€é«˜,æ‰§è¡Œé¡ºåºå¦‚ä¸‹:

1. åˆ›å»º HTTP è¯·æ±‚å¯¹è±¡
2. è°ƒç”¨ `SetupRequestHeader` è®¾ç½®åŸºç¡€è¯·æ±‚å¤´ï¼ˆå¦‚ Authorizationï¼‰
3. **åº”ç”¨ `headerOverride` è¦†ç›–** â† ç¡®ä¿æœ€é«˜ä¼˜å…ˆçº§
4. å‘é€è¯·æ±‚

è¿™æ ·å¯ä»¥ä¿è¯ç”¨æˆ·é…ç½®çš„è¯·æ±‚å¤´è¦†ç›–ä¸ä¼šè¢«å…¶ä»–åœ°æ–¹æ„å¤–è¦†ç›–ã€‚

---

## FAQ

### Q1: ç®€å•æ¨¡å¼å’Œé«˜çº§æ¨¡å¼å¯ä»¥æ··ç”¨å—ï¼Ÿ

**A**: ä¸å»ºè®®æ··ç”¨ã€‚ä¸€æ—¦é…ç½®ä¸­å­˜åœ¨ `operations` å­—æ®µï¼Œç³»ç»Ÿå°±ä¼šåªä½¿ç”¨é«˜çº§æ¨¡å¼ï¼Œç®€å•æ¨¡å¼çš„é…ç½®ä¼šè¢«å¿½ç•¥ã€‚

### Q2: é…ç½®è§£æå¤±è´¥ä¼šæŠ¥é”™å—ï¼Ÿ

**A**: ä¸ä¼šã€‚è§£æå¤±è´¥æ—¶ä¼šè§¦å‘"å®‰å…¨å›é€€"ï¼Œä¸åšä»»ä½•è¯·æ±‚å¤´è¦†ç›–ï¼Œè¯·æ±‚ä¼šä½¿ç”¨åŸå§‹çš„è¯·æ±‚å¤´ã€‚

### Q3: å¦‚ä½•çŸ¥é“é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

**A**:
1. è§‚å¯Ÿä¸Šæ¸¸æœåŠ¡æ”¶åˆ°çš„è¯·æ±‚å¤´
2. æ£€æŸ¥åº”ç”¨æ—¥å¿—
3. ä½¿ç”¨å•å…ƒæµ‹è¯•éªŒè¯é…ç½®

### Q4: condition ä¸­çš„ header å’Œ value ä¸ºç©ºä¼šæ€æ ·ï¼Ÿ

**A**: å•ä¸ª condition çš„ `header`/`value` ä¸ºç©ºä¼šè¢«è·³è¿‡ï¼Œä½†å¦‚æœ `conditions` æä¾›åæœ€ç»ˆæ²¡æœ‰ä»»ä½•æœ‰æ•ˆæ¡ä»¶ï¼ˆæˆ–æ•°ç»„æœ¬èº«ä¸ºç©ºï¼‰ï¼Œæ•´ä¸ªé«˜çº§æ¨¡å¼ä¼šè§£æå¤±è´¥å¹¶å›é€€ä¸ºâ€œä¸è¦†ç›–â€ã€‚operation è‡ªèº«çš„ `header`/`value` ä¸ºç©ºåŒæ ·ä¼šç›´æ¥è§£æå¤±è´¥ã€‚

### Q5: å¤šä¸ª operation è¦†ç›–åŒä¸€ä¸ª header ä¼šæ€æ ·ï¼Ÿ

**A**: åé¢çš„ä¼šè¦†ç›–å‰é¢çš„ã€‚æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ operation éƒ½ä¼šæ‰§è¡Œï¼Œæœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚

### Q6: æ€§èƒ½å½±å“æœ‰å¤šå¤§ï¼Ÿ

**A**: æ¯ä¸ªè¯·æ±‚ä¼šæ‰§è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œä½†éƒ½æ˜¯ç®€å•çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œæ€§èƒ½å½±å“å¯ä»¥å¿½ç•¥ã€‚å»ºè®®æ§åˆ¶ conditions å’Œ operations çš„æ•°é‡åœ¨åˆç†èŒƒå›´å†…ã€‚

### Q7: å¦‚ä½•æ‰©å±•æ–°çš„å˜é‡ï¼Ÿ

**A**: ä¿®æ”¹ `replaceHeaderVariables` å‡½æ•°ï¼Œæ·»åŠ æ–°çš„å˜é‡æ›¿æ¢é€»è¾‘ï¼š

```go
func replaceHeaderVariables(str string, info *RelayInfo) string {
    // ç°æœ‰çš„ api_key
    if strings.Contains(str, "{api_key}") {
        str = strings.ReplaceAll(str, "{api_key}", info.ApiKey)
    }
    // æ·»åŠ æ–°å˜é‡
    if strings.Contains(str, "{model}") {
        str = strings.ReplaceAll(str, "{model}", info.Model)
    }
    return str
}
```

---

## ç‰ˆæœ¬å†å²

### v1.0.0 (å½“å‰ç‰ˆæœ¬)

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… æ¡ä»¶åˆ¤æ–­çš„è¯·æ±‚å¤´è¦†ç›–
- âœ… æ”¯æŒ 4 ç§åŒ¹é…æ¨¡å¼ï¼ˆfull/prefix/suffix/containsï¼‰
- âœ… æ”¯æŒ AND/OR é€»è¾‘ç»„åˆ
- âœ… æ”¯æŒæ¡ä»¶å–åï¼ˆinvertï¼‰
- âœ… æ”¯æŒå˜é‡æ›¿æ¢ï¼ˆ{api_key}ï¼‰
- âœ… å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–

**å‘åå…¼å®¹**ï¼š
- âœ… å®Œå…¨å…¼å®¹ç°æœ‰ç®€å•æ¨¡å¼é…ç½®

**æ”¹åŠ¨æ–‡ä»¶**ï¼š
- æ–°å¢ï¼š`relay/common/header_override.go` (181 è¡Œ)
- æ–°å¢ï¼š`relay/common/header_override_test.go` (464 è¡Œ)
- ä¿®æ”¹ï¼š`relay/channel/api_request.go` (+28, -5)

---

## æ€»ç»“

æœ¬æ¬¡æ›´æ–°ä¸º new-api é¡¹ç›®å¸¦æ¥äº†å¼ºå¤§è€Œçµæ´»çš„è¯·æ±‚å¤´æ¡ä»¶è¦†ç›–åŠŸèƒ½ï¼Œä¸»è¦ç‰¹ç‚¹ï¼š

âœ… **å‘åå…¼å®¹**ï¼šç°æœ‰é…ç½®æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­ä½¿ç”¨
âœ… **åŠŸèƒ½å¼ºå¤§**ï¼šæ”¯æŒå¤šç§åŒ¹é…æ¨¡å¼å’Œé€»è¾‘ç»„åˆ
âœ… **å®‰å…¨å¯é **ï¼šé…ç½®é”™è¯¯æ—¶è‡ªåŠ¨å®‰å…¨å›é€€
âœ… **æ˜“äºä½¿ç”¨**ï¼šæ¸…æ™°çš„é…ç½®ç»“æ„å’Œä¸°å¯Œçš„ç¤ºä¾‹
âœ… **æµ‹è¯•å……åˆ†**ï¼š464 è¡Œå•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰å…³é”®åœºæ™¯

å»ºè®®åœ¨ä½¿ç”¨æ—¶ï¼š
- ä»ç®€å•é…ç½®å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦
- å……åˆ†æµ‹è¯•é…ç½®åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- éµå¾ªæœ€ä½³å®è·µï¼Œé¿å…å¸¸è§é…ç½®é”™è¯¯
